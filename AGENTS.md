# kindle2cosense エージェント向けガイド

このガイドは、AIエージェントが `kindle2cosense` リポジトリを理解し、対話するためのものです。

## プロジェクトの目的

このプロジェクトは、Kindleからエクスポートされた書籍データ（JSON形式）を、「Cosense」というサービスで要求される特定のJSON形式に変換するPythonスクリプトで構成されています。

主な目的は以下の通りです：
- KindleのJSONからCosenseのJSON構造へフィールドをマッピングする。
- 書籍のタイトルを解析してシリーズ名や出版社/レーベル情報を抽出し、知的なグルーピングを行う。

## 変換の実行方法

主要なワークフローは `Makefile` によって管理されています。

変換を実行するには：
1. 入力ファイル `input/kindle.json` が存在し、Kindleからエクスポートされたデータが含まれていることを確認します。
2. `make` コマンドを実行します。

```sh
make
```

このコマンドは `kindle2cosense.py` スクリプトを実行し、`input/kindle.json` を読み込んで `build/cosense.json` に出力ファイルを生成します。

生成されたファイルをクリーンアップするには、次を実行します：
```sh
make clean
```

## 主要ファイル

- **`kindle2cosense.py`**: すべての変換ロジックを含む主要なPythonスクリプトです。入力を読み込み、データを変換し、出力を書き込みます。直接実行することも可能です。

- **`input/kindle.json`**: 入力データファイルです。これは、各オブジェクトがKindleの書籍を表すJSONオブジェクトの配列でなければなりません。期待されるフォーマットは `spec.md` に詳述されています。

- **`build/cosense.json`**: スクリプトによって生成される出力ファイルです。これはCosenseへのインポートを意図したファイルです。

- **`Makefile`**: プロジェクトのワークフローを管理するための `make`, `build`, `clean` コマンドを定義しています。

- **`spec.md`**: **要求仕様の唯一の信頼できる情報源（Single Source of Truth）です。** このドキュメントは、正確な入出力JSONフォーマットとそれらの間のマッピングルールを規定しています。また、「グルーピング」機能の例も提供しています。変換ロジックへのいかなる変更も、この仕様に沿う必要があります。

- **`grouping.md`**: このドキュメントは、タイトルグルーピング機能のハイレベルな戦略とルールを概説しています。書籍のタイトルからシリーズ名やレーベルを抽出する方法に関するコンテキストと提案（正規表現を含む）を提供します。`kindle2cosense.py` の実装は、このファイルにあるアイデアに基づいています。

## コアロジックの概要

スクリプト `kindle2cosense.py` は以下のステップを実行します：
1. `input/kindle.json` から書籍オブジェクトの配列を読み込みます。
2. 各書籍オブジェクトを反復処理します。
3. 各書籍について、Cosenseフォーマットに対応する「ページ」オブジェクトを作成します。
4. **タイトルグルーピング**: スクリプト内の `extract_groups` 関数が重要な機能です。この関数は一連の正規表現を使用して書籍の `title` 文字列を解析します。目的は以下の情報を特定し、抽出することです：
    - メインのシリーズ名（例：「My Series Vol. 1」から「My Series」）。
    - 出版社またはレーベル（例：「Title (Beam Comics)」から「Beam Comics」）。
    抽出された名前は、リンクとして出力に追加されます。このロジックに関する詳細な要件と例は `spec.md` と `grouping.md` に記載されています。
5. 他のすべてのフィールド（`authors`, `asin`, `acquiredTime` など）は `spec.md` で指定されている通りに、Cosenseページの `lines` 配列にマッピングおよびフォーマットされます。
6. ページの最終的なコレクションが `build/cosense.json` に書き込まれます。

## スクリプトの変更方法

スクリプトの振る舞いを変更するよう依頼された場合（例：バグ修正、機能追加）：

1. **最初に `spec.md` を参照してください。** 要求される入力から出力へのマッピングを理解します。リクエストが仕様と矛盾する場合は、それを指摘してください。仕様の更新が必要な場合は、それは別のタスクとして扱うべきです。
2. **`kindle2cosense.py` を調査してください。** メインのロジックは `convert_kindle_to_cosense` 関数にあります。変更がタイトル解析に関するものである場合は、`extract_groups` 内部関数に焦点を当ててください。
3. **コンテキストのために `spec.md` と `grouping.md` を使用してください。** 特にグルーピングロジックについては、これらに価値のある例や提案されたルールが含まれています。
4. **変更をテストしてください。** スクリプトを変更した後、`make` を実行してエラーなく実行され、`input/kindle.json` ファイルに基づいて期待される `build/cosense.json` 出力が生成されることを確認します。変更を検証するために、入力ファイル内のテストケースを作成または変更する必要があるかもしれません。